name: Docker Fullstack CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ Set up Docker
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # 3️⃣ Log in to DockerHub
    - name: Log in to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 4️⃣ Build backend image
    - name: Build backend image
      run: |
        docker build -t akashvip100/docker-fullstack-backend_app:latest -f backend/backend.Dockerfile backend/

    # 5️⃣ Build frontend image
    - name: Build frontend image
      run: |
        docker build -t akashvip100/docker-fullstack-frontend_app:latest -f frontend/frontend.Dockerfile frontend/

    # 6️⃣ Push images to DockerHub
    - name: Push backend image
      run: docker push akashvip100/docker-fullstack-backend_app:latest

    - name: Push frontend image
      run: docker push akashvip100/docker-fullstack-frontend_app:latest

    # 7️⃣ Deploy using docker-compose (optional)
    # If you have a server, you can SSH and run docker-compose there
    # Example:
    # - name: Deploy to server
    #   uses: appleboy/ssh-action@master
    #   with:
    #     host: ${{ secrets.SERVER_IP }}
    #     username: ${{ secrets.SERVER_USER }}
    #     key: ${{ secrets.SERVER_SSH_KEY }}
    #     script: |
    #       cd /path/to/project
    #       docker-compose pull
    #       docker-compose up -d --build

